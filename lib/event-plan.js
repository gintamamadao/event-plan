"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var r=t(require("regenerator-runtime")),n=t(require("imitate-symbol")),e=r;function a(t,r,n,e,a,o,u){try{var i=t[o](u),s=i.value}catch(t){return void n(t)}i.done?r(s):Promise.resolve(s).then(e,a)}var o=function(t){return function(){var r=this,n=arguments;return new Promise((function(e,o){var u=t.apply(r,n);function i(t){a(u,e,o,i,s,"next",t)}function s(t){a(u,e,o,i,s,"throw",t)}i(void 0)}))}};var u=function(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")},i="#_EVENT_PLAN_TASK_FINISH_#";module.exports=function t(r){var a=this;u(this,t),this.eventsMap={},this.taskStatusMap={},this.taskLockMap={},this.taskWaitQueue={},this.globalConfig={},this.on=function(t,r){var n=a.eventsMap,e=n[t]||[];return"function"==typeof r&&e.push(r),n[t]=e,a.eventsMap=n,function(){a.off(t,r)}},this.emit=function(){var t=o(e.mark((function t(r){var n,o,u,i,s,f=arguments;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(n=f.length,o=new Array(n>1?n-1:0),u=1;n>u;u++)o[u-1]=f[u];return i=a.eventsMap[r]||[],t.next=5,Promise.all(i.map((function(t){return t.apply(null,[].concat(o,[a.globalConfig]))})));case 5:if(1<(s=t.sent).length){t.next=10;break}return t.abrupt("return",s[0]);case 10:return t.abrupt("return",s);case 11:case"end":return t.stop()}}),t)})));return function(r){return t.apply(this,arguments)}}(),this.off=function(t,r){var n=a.eventsMap||{},e=n[t]||[];"function"!=typeof r?n[t]=[]:(e=e.filter((function(t){return t!==r})),n[t]=e)},this.registerTask=function(t,r,e){if(!a.taskLockMap[t]){var o=t;t=n.for(t);var u=a.on(t,r);if(a.taskStatusMap[t]=!1,Array.isArray(e)&&e.length>0&&!a.taskWaitQueue[t]){a.on(n.for(i),(function r(){e.every((function(t){return a.taskStatusMap[n.for(t)]}))&&(a.startTask(o),a.off(n.for(i),r),a.taskWaitQueue[t]=!1)})),a.taskWaitQueue[t]=!0,setTimeout((function(){a.emit(n.for(i))}),0)}return u}},this.startTask=function(){var t=o(e.mark((function t(r){var o,u,s,f,c=arguments;return e.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=n.for(r),!a.taskLockMap[r]){t.next=3;break}return t.abrupt("return");case 3:for(a.taskLockMap[r]=!0,o=c.length,u=new Array(o>1?o-1:0),s=1;o>s;s++)u[s-1]=c[s];return t.next=7,a.emit.apply(a,[r].concat(u));case 7:return f=t.sent,a.taskLockMap[r]=!1,a.taskStatusMap[r]=!0,a.off(r),a.emit(n.for(i)),t.abrupt("return",f);case 13:case"end":return t.stop()}}),t)})));return function(r){return t.apply(this,arguments)}}(),this.startTaskDevs=function(t){var r,u=1>(r=(arguments.length>1?arguments.length-1:0)-1+1)||r>=arguments.length?void 0:arguments[r];if(Array.isArray(u)&&u.length>0&&!a.taskLockMap[n.for(t)]){var s,f=function(){var r=o(e.mark((function r(){var o;return e.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!u.every((function(t){return a.taskStatusMap[n.for(t)]}))){r.next=8;break}return r.next=4,a.startTask(t);case 4:o=r.sent,a.off(n.for(i),f),a.taskWaitQueue[t]=!1,s&&s(o);case 8:case"end":return r.stop()}}),r)})));return function(){return r.apply(this,arguments)}}();return a.on(n.for(i),f),a.taskWaitQueue[n.for(t)]=!0,a.emit(n.for(i)),new Promise((function(t){s=function(r){t(r)}}))}},this.globalConfig=r||{}};
