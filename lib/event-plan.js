"use strict";var t,r=(t=require("imitate-symbol"))&&"object"==typeof t&&"default"in t?t.default:t;function n(t,r,n,e,a,o,u){try{var i=t[o](u),s=i.value}catch(t){return void n(t)}i.done?r(s):Promise.resolve(s).then(e,a)}function e(t){return function(){var r=this,e=arguments;return new Promise((function(a,o){var u=t.apply(r,e);function i(t){n(u,a,o,i,s,"next",t)}function s(t){n(u,a,o,i,s,"throw",t)}i(void 0)}))}}var a="#_EVENT_PLAN_TASK_FINISH_#";module.exports=function t(n){var o=this;!function(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}(this,t),this.eventsMap={},this.taskStatusMap={},this.taskLockMap={},this.taskWaitQueue={},this.globalConfig={},this.on=function(t,r){var n=o.eventsMap,e=n[t]||[];return"function"==typeof r&&e.push(r),n[t]=e,o.eventsMap=n,function(){o.off(t,r)}},this.emit=function(){var t=e(regeneratorRuntime.mark((function t(r){var n,e,a,u,i,s=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(n=s.length,e=new Array(n>1?n-1:0),a=1;n>a;a++)e[a-1]=s[a];return u=o.eventsMap[r]||[],t.next=5,Promise.all(u.map((function(t){return t.apply(null,[].concat(e,[o.globalConfig]))})));case 5:if(1<(i=t.sent).length){t.next=10;break}return t.abrupt("return",i[0]);case 10:return t.abrupt("return",i);case 11:case"end":return t.stop()}}),t)})));return function(r){return t.apply(this,arguments)}}(),this.off=function(t,r){var n=o.eventsMap||{},e=n[t]||[];"function"!=typeof r?n[t]=[]:(e=e.filter((function(t){return t!==r})),n[t]=e)},this.registerTask=function(t,n,e){if(!o.taskLockMap[t]){var u=t;t=r.for(t);var i=o.on(t,n);if(o.taskStatusMap[t]=!1,Array.isArray(e)&&e.length>0&&!o.taskWaitQueue[t]){o.on(r.for(a),(function n(){e.every((function(t){return o.taskStatusMap[r.for(t)]}))&&(o.startTask(u),o.off(r.for(a),n),o.taskWaitQueue[t]=!1)})),o.taskWaitQueue[t]=!0,o.emit(r.for(a))}return i}},this.startTask=function(){var t=e(regeneratorRuntime.mark((function t(n){var e,u,i,s,f=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=r.for(n),!o.taskLockMap[n]){t.next=3;break}return t.abrupt("return");case 3:for(o.taskLockMap[n]=!0,e=f.length,u=new Array(e>1?e-1:0),i=1;e>i;i++)u[i-1]=f[i];return t.next=7,o.emit.apply(o,[n].concat(u));case 7:return s=t.sent,o.taskLockMap[n]=!1,o.taskStatusMap[n]=!0,o.off(n),o.emit(r.for(a)),t.abrupt("return",s);case 13:case"end":return t.stop()}}),t)})));return function(r){return t.apply(this,arguments)}}(),this.startTaskDevs=function(t){var n,u=1>(n=(arguments.length>1?arguments.length-1:0)-1+1)||n>=arguments.length?void 0:arguments[n];if(Array.isArray(u)&&u.length>0&&!o.taskLockMap[r.for(t)]){var i,s=function(){var n=e(regeneratorRuntime.mark((function n(){var e;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!u.every((function(t){return o.taskStatusMap[r.for(t)]}))){n.next=8;break}return n.next=4,o.startTask(t);case 4:e=n.sent,o.off(r.for(a),s),o.taskWaitQueue[t]=!1,i&&i(e);case 8:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}();return o.on(r.for(a),s),o.taskWaitQueue[r.for(t)]=!0,o.emit(r.for(a)),new Promise((function(t){i=function(r){t(r)}}))}},this.globalConfig=n||{}};
